# オンライン版得点表示Playwrightテストシナリオ

## 概要

このドキュメントは、Score Watcherのオンライン版得点表示機能の動作を保証するためのPlaywrightテストシナリオを定義します。オンライン版はクラウドデータベース（Turso DB）と連携し、リアルタイムでスコア管理を行う機能です。

## テスト環境設定

### 認証設定

- ヘッダーベースの認証バイパスを使用
- テストユーザー: `test-user-playwright`
- 認証ヘッダー: `x-test-user-id` および `x-playwright-test`

### 初期化処理

```javascript
await context.setExtraHTTPHeaders({
  "x-test-user-id": "test-user-playwright",
  "x-playwright-test": "true",
});
```

## 主要テストシナリオ

### 1. 基本アクセステスト

#### 1.1 オンラインゲーム一覧ページへのアクセス

- **目的**: `/online/games`にアクセスできることを確認
- **検証項目**:
  - ページURLが正しく表示される
  - ページタイトルに「ゲーム一覧」が含まれる
- **期待結果**: 認証済みユーザーがゲーム一覧ページを表示できる

#### 1.2 認証が必要なページのリダイレクト

- **目的**: 未認証ユーザーがサインインページにリダイレクトされることを確認
- **検証項目**: `/sign-in`以外のURLが表示される
- **期待結果**: 認証済みユーザーは適切なページが表示される

### 2. ゲーム作成・管理テスト

#### 2.1 オンラインゲーム作成

- **目的**: 新規ゲームを作成できることを確認
- **手順**:
  1. ゲーム管理ページで「作成」ボタンをクリック
  2. ゲーム名を入力（例: "Playwrightテストゲーム"）
  3. 形式を選択（normal形式）
  4. 作成ボタンをクリック
- **検証項目**:
  - モーダルが正しく表示される
  - ゲーム設定ページにリダイレクトされる
  - ゲーム名が正しく表示される
- **期待結果**: 新しいゲームが正常に作成され、設定ページに移動する

#### 2.2 プレイヤー作成と追加

- **目的**: ゲームにプレイヤーを追加できることを確認
- **手順**:
  1. ゲーム設定ページでプレイヤータブに移動
  2. プレイヤー管理ページに移動
  3. 複数のテストプレイヤーを作成
- **検証項目**:
  - プレイヤー名の入力と追加
  - プレイヤーリストへの正しい追加
  - 成功メッセージの表示
- **期待結果**: 指定した名前のプレイヤーが正常に追加される

### 3. ボードページ機能テスト

#### 3.1 ボードページ表示

- **目的**: ゲームボードが正しく表示されることを確認
- **検証項目**:
  - ボードページURL（`/online/games/[game_id]/board`）
  - ページタイトル「クラウド得点表示」
  - 問題番号の初期表示（Q1）
- **期待結果**: ボードページが正常に読み込まれ、初期状態が表示される

#### 3.2 プレイヤー表示とスコア操作

- **目的**: プレイヤーのスコア表示と操作が正常に動作することを確認
- **検証項目**:
  - プレイヤー名の表示
  - 初期スコア（0pt）の表示
  - スコアボタンのクリック操作
  - スコア更新後の表示（1pt）
  - 操作ログの記録
  - 問題番号の自動進行（Q2）
- **期待結果**: プレイヤーのスコア操作が正常に動作し、ログに記録される

### 4. ゲーム操作機能テスト

#### 4.1 スルー操作

- **目的**: スルー機能が正常に動作することを確認
- **手順**:
  1. スルーボタンをクリック（デスクトップ）
  2. または、メニューからスルー選択（モバイル）
- **検証項目**:
  - 問題番号の進行
  - ログテーブルへのスルー記録
  - ログ内容（プレイヤー名: "(スルー)", 結果: "-"）
- **期待結果**: スルー操作が正常に実行され、適切にログに記録される

#### 4.2 Undo（元に戻す）操作

- **目的**: 操作の取り消し機能が正常に動作することを確認
- **前提条件**: 既にスコア操作が実行されている状態
- **手順**:
  1. 一つ戻すボタンをクリック（デスクトップ）
  2. または、メニューから一つ戻すを選択（モバイル）
- **検証項目**:
  - 問題番号の逆行（Q2→Q1）
  - スコアの元の値への復帰（1pt→0pt）
  - ログからの該当操作の削除
- **期待結果**: 最後の操作が正常に取り消される

### 5. キーボードショートカット機能テスト

#### 5.1 数字キーによるプレイヤー操作

- **目的**: キーボードショートカットが正常に動作することを確認
- **検証項目**:
  - 数字キー1-9でプレイヤー正解操作
  - Shiftキー + 数字キーでプレイヤー不正解操作
  - 数字キー0で10番目のプレイヤー操作
- **期待結果**: キーボードショートカットでプレイヤー操作が実行される

#### 5.2 その他のキーボードショートカット

- **目的**: その他のショートカット機能を確認
- **検証項目**:
  - カンマキーまたはCtrl+Z/Cmd+ZでUndo操作
  - ピリオドキーでスルー操作
- **期待結果**: 各ショートカットが適切に動作する

### 6. レスポンシブ表示テスト

#### 6.1 モバイル表示対応

- **目的**: モバイルデバイスでの表示と操作を確認
- **検証項目**:
  - モバイル画面でのレイアウト
  - ハンバーガーメニューの表示
  - メニューからの各種操作（スルー、Undo）
- **期待結果**: モバイルデバイスでも全機能が正常に動作する

### 7. 特殊ルール対応テスト

#### 7.1 AQLルール表示

- **目的**: AQL形式での特別な表示が正常に動作することを確認
- **検証項目**:
  - AQLコンポーネントの表示
  - チーム名の表示
  - AQL特有の操作UI
- **期待結果**: AQL形式のゲームで専用UIが表示される

#### 7.2 SquareXルール表示

- **目的**: SquareX形式での特別な表示を確認
- **検証項目**:
  - 問題番号に応じたバーの表示位置
  - 奇数問題/偶数問題での表示切り替え
- **期待結果**: SquareX形式で専用のビジュアル要素が表示される

### 8. エラーハンドリングテスト

#### 8.1 ネットワークエラー対応

- **目的**: ネットワーク障害時の動作を確認
- **検証項目**:
  - API通信失敗時のエラーメッセージ
  - ローディング状態の適切な表示
  - ボタンの無効化（連打防止）
- **期待結果**: エラー時も適切なフィードバックが提供される

#### 8.2 データ整合性エラー

- **目的**: データの不整合が発生した場合の対応を確認
- **検証項目**:
  - 存在しないゲームIDへのアクセス時の処理
  - 無効なプレイヤーIDでの操作時の処理
- **期待結果**: 不正なデータアクセス時も適切にエラーハンドリングされる

### 9. パフォーマンステスト

#### 9.1 大量ログ処理

- **目的**: 多くの操作ログがある状態での動作を確認
- **検証項目**:
  - 100回以上の操作後の表示速度
  - ログテーブルの表示パフォーマンス
  - メモリ使用量の適切性
- **期待結果**: 大量のログがあってもパフォーマンスが維持される

#### 9.2 リアルタイム更新

- **目的**: データの自動更新が正常に動作することを確認
- **検証項目**:
  - 他のユーザーによる操作の反映
  - 自動リフレッシュのタイミング
  - 競合状態の適切な処理
- **期待結果**: リアルタイムでデータが同期される

### 10. アクセシビリティテスト

#### 10.1 キーボードナビゲーション

- **目的**: キーボードのみでの操作が可能であることを確認
- **検証項目**:
  - Tabキーでの要素間移動
  - EnterキーやSpaceキーでの操作実行
  - フォーカスの可視化
- **期待結果**: キーボードのみで全機能が利用可能

#### 10.2 スクリーンリーダー対応

- **目的**: 適切なaria属性とセマンティックHTMLが使用されていることを確認
- **検証項目**:
  - ボタンやリンクのaria-label
  - テーブルのヘッダー関連付け
  - 動的コンテンツの読み上げ対応
- **期待結果**: スクリーンリーダーで適切に内容が伝わる

## テスト実行指針

### テストの実行順序

1. 基本アクセステスト
2. ゲーム作成・管理テスト
3. ボードページ機能テスト
4. ゲーム操作機能テスト
5. 特殊ルール対応テスト
6. エラーハンドリングテスト

### テストデータの管理

- 各テストで使用するテストデータは独立して管理
- テスト終了後のクリーンアップを適切に実行
- 本番データへの影響を防ぐためのテスト環境分離

### 継続的インテグレーション

- プルリクエスト作成時の自動テスト実行
- 主要ブラウザでのクロスブラウザテスト
- 定期的なリグレッションテストの実行

## テスト実装時の注意点

### 待機処理

- API通信完了まで適切に待機
- DOM要素の表示完了を確認
- アニメーション完了後の状態チェック

### テストの安定性

- フレイキーテストの回避
- 明示的な待機条件の設定
- エラー時の適切なリトライ処理

### デバッグ支援

- スクリーンショット撮影機能の活用
- 詳細なエラーメッセージの出力
- テスト実行時のログ出力

このテストシナリオにより、オンライン版得点表示機能の品質と安定性を継続的に保証することができます。
