# オンライン機能 実装状況と要件ドキュメント

Score Watcherプロジェクトのオンライン版実装状況と残存タスクの詳細をまとめます。

## プロジェクト構造概要

Score Watcherは**ローカル版とオンライン版の二重実装**を持つ独特のアーキテクチャです。

### ローカル版

- **データ保存**: IndexedDB（Dexie.js）
- **認証**: なし（プロファイルによる簡易分離）
- **動作環境**: 完全オフライン
- **用途**: 個人利用・軽量操作

### オンライン版

- **データ保存**: Turso SQLite（Drizzle ORM）
- **認証**: Better Auth（Google OAuth）
- **動作環境**: オンライン必須
- **用途**: マルチユーザー・データ同期

## オンライン版実装状況

オンライン機能は**完全に実装済み**です。基本的なゲーム機能（作成・設定・プレイ・表示）はすべて動作しており、実用レベルに達しています。

### 実装済み機能詳細

#### 認証システム

- **実装場所**: `src/utils/auth/auth.ts`
- **機能**: Better Auth + Google OAuth（GitHubは未実装）
- **特徴**: セッション管理（7日間有効）、自動ユーザー設定作成

#### データベース設計

- **スキーマ**: `src/utils/drizzle/schema/`
- **テーブル**: game, player, quiz_set, game_log, user_preference等
- **特徴**: 正規化設計、論理削除、ユーザー分離

#### API Routes

- **実装場所**: `src/server/index.ts`, `src/server/controllers/`
- **特徴**: Hono + Zod完全型安全、全CRUD操作対応
- **エンドポイント数**: 30以上の完全実装済みAPI

#### フロントエンド画面

- **ゲーム管理**: `src/app/(default)/online/games/`
- **プレイヤー管理**: `src/app/(default)/online/players/`
- **クイズ管理**: `src/app/(default)/online/quizes/`
- **ボード表示**: `src/app/(board)/online/games/[game_id]/board/`

#### スコア計算エンジン

- **実装場所**: `src/utils/online/computeScore/`
- **対応形式**: 17種類（normal, nomx, aql, swedish10等）
- **最適化**: Map使用による高速計算、型安全性強化

#### 同期機能

- **方式**: 2秒間隔ポーリング
- **実装場所**: Board コンポーネント内
- **特徴**: 自動リフレッシュ、競合回避

### ローカル版との主な差異

| 項目           | ローカル版            | オンライン版      |
| -------------- | --------------------- | ----------------- |
| データ保存     | IndexedDB             | Turso SQLite      |
| 認証           | なし                  | Google OAuth      |
| 同期           | リアルタイム（Dexie） | ポーリング（API） |
| ユーザー分離   | プロファイル          | userId            |
| アクセス制御   | なし                  | 認証必須          |
| データ永続化   | ローカル              | クラウド          |
| マルチデバイス | 非対応                | 対応              |

## 残存タスク一覧

### 🔴 高優先度タスク

#### 1. Discord Webhook機能（部分実装済み）

**現状**:

- データベーススキーマに`discord_webhook_url`フィールド実装済み
- 設定フォーム実装済み（`OtherConfig.tsx`）
- 保存・取得API実装済み
- **未実装**: ゲーム終了時の自動通知機能のみ

**残り実装**:

- ゲーム終了判定ロジック
- Webhook送信処理
- 通知メッセージフォーマット
- エラーハンドリング

**実装ファイル**:

```
src/utils/discord-webhook.ts                          # 新規作成（通知処理）
src/app/(board)/online/games/[game_id]/board/_components/Board/Board.tsx  # 終了判定追加
```

### 🟡 中優先度タスク（パフォーマンス・体験向上）

#### 2. WebSocketによるリアルタイム同期

**現状**: 2秒間隔のポーリングで動作（基本機能は問題なし）  
**改善効果**: レスポンス性向上、サーバー負荷軽減  
**必要な実装**:

- WebSocketサーバーの構築
- リアルタイム操作配信
- 接続状態の監視・復旧
- フォールバック機能（ポーリング）

#### 3. オフライン対応機能

**現状**: オンライン環境でのみ動作  
**改善効果**: ネットワーク不安定時の利便性向上  
**必要な実装**:

- オフライン操作のキューイング
- 復帰時の自動同期
- Service Workerによるキャッシュ
- 競合解決システム

#### 4. セキュリティ強化

**現状**: 基本的な認証・アクセス制御は実装済み  
**改善効果**: より安全な運用  
**必要な実装**:

- API認証の強化（Better Authセッション活用）
- レート制限機能
- セキュリティログ・監査機能
- 自動ログアウト機能

### 🟢 低優先度タスク（将来的な拡張）

#### 5. 高度な同期・競合解決

**対象**: 複数ユーザーが同時編集する場合の高度な制御  
**必要な実装**:

- Operational Transform
- 競合検出・解決UI
- 差分同期による最適化

#### 6. GDPR対応機能

**対象**: プライバシー・コンプライアンス強化  
**必要な実装**:

- ユーザーデータの完全削除機能
- データエクスポート機能
- データ暗号化機能

#### 7. 管理者機能

**対象**: 将来的なマルチユーザー対応  
**必要な実装**:

- ユーザーロール管理
- システム監視機能
- 一括データ管理機能

## 実装優先順位

### フェーズ1: 基本機能完成（高優先度）

1. **Discord Webhook機能** - 唯一の未実装基本機能

### フェーズ2: パフォーマンス向上（中優先度）

2. **WebSocketリアルタイム同期** - ユーザー体験の大幅改善
3. **セキュリティ強化** - 本格運用に向けた安全性確保
4. **オフライン対応** - 利便性向上

### フェーズ3: 高度な機能（低優先度）

5. **競合解決システム** - 複数ユーザー対応
6. **GDPR対応** - コンプライアンス強化
7. **管理者機能** - スケーラビリティ対応

## 機能完成度マトリックス

| 機能カテゴリ         | 完成度 | ファイル場所                                    | 備考                 |
| -------------------- | ------ | ----------------------------------------------- | -------------------- |
| **認証システム**     | 100%   | `src/utils/auth/`                               | Google OAuth完全実装 |
| **ゲーム作成・管理** | 100%   | `src/app/(default)/online/games/`               | 17形式対応           |
| **プレイヤー管理**   | 100%   | `src/app/(default)/online/players/`             | CRUD+タグ管理        |
| **クイズ管理**       | 100%   | `src/app/(default)/online/quizes/`              | セット管理対応       |
| **ボード表示・操作** | 100%   | `src/app/(board)/online/games/[game_id]/board/` | リアルタイム表示     |
| **API Routes**       | 100%   | `src/server/`                                   | 30+エンドポイント    |
| **データベース**     | 100%   | `src/utils/drizzle/`                            | 正規化済み設計       |
| **スコア計算**       | 100%   | `src/utils/online/computeScore/`                | 全形式最適化済み     |
| **同期機能**         | 100%   | Board コンポーネント                            | ポーリング方式       |
| **設定管理**         | 100%   | `src/models/user-preferences.ts`                | クラウド同期         |
| **Discord連携**      | 80%    | 設定UI実装済み                                  | 通知機能のみ未実装   |
| **リアルタイム同期** | 0%     | -                                               | WebSocket未実装      |
| **オフライン対応**   | 0%     | -                                               | オンライン専用設計   |

### 実装技術スタック

| 層                 | 技術                              | 実装状況 |
| ------------------ | --------------------------------- | -------- |
| **認証**           | Better Auth + Google OAuth        | ✅ 完成  |
| **フロントエンド** | Next.js 15 + TypeScript + Mantine | ✅ 完成  |
| **API**            | Hono + Zod                        | ✅ 完成  |
| **データベース**   | Turso SQLite + Drizzle ORM        | ✅ 完成  |
| **スタイリング**   | CSS Modules                       | ✅ 完成  |
| **テスト**         | Vitest + Playwright               | ✅ 完成  |
| **デプロイ**       | Vercel                            | ✅ 完成  |

## まとめ

**現在の状況**: オンライン機能はほぼ完成しており、基本的なクイズゲームの運用には十分な機能を提供しています。

**即座に必要な作業**: Discord Webhook機能の実装のみです。

**改善の方向性**: パフォーマンス最適化（WebSocket）とセキュリティ強化に焦点を当てることで、より本格的なサービスレベルに到達できます。

**開発工数の見積もり**:

- Discord Webhook: 1-2日
- WebSocket同期: 1-2週間
- セキュリティ強化: 3-5日
- オフライン対応: 1-2週間
