# Score Watcher 機能概要

Score Watcher は、競技クイズのスコア管理と表示に特化した Web アプリケーションです。ローカル環境（IndexedDB）で完結するオフライン運用と、ログインして利用するオンライン運用の両方に対応しており、現場での迅速なスコアリングから大規模なイベントでの公開・観戦まで幅広い用途をサポートします。

## ローカル（オフライン）機能

端末内に構築された IndexedDB を用いて、プレイヤー・問題・ゲームのデータを保存します。データはブラウザごとの「プロフィール（`scorew_current_profile`）」で切り替えられるため、用途に応じてデータ領域を分離できます。プレイヤー管理では、個別追加、タブ区切りやカンマ区切りテキストの貼り付け、CSV インポートに対応し、一覧では検索と一括削除が行えます。問題管理も読み込み・インポートの導線を持ち、セット名や問題番号を含む基本項目を扱えます。形式一覧ページからは対応するゲーム形式を選択して新規ゲームを作成でき、作成後は各形式に応じた設定値や初期値、プレイヤーの並び順・初期スコア等を調整できます。ゲームは JSON 形式でエクスポートでき、バックアップや移行に利用できます。

ローカルの得点表示は、ゲームごとのスコア計算ロジックに基づいてリアルタイムに表示を更新します。ヘッダーにはゲーム名と形式の要約、問題番号を表示でき、問題セットが紐づく場合は進行に合わせて問題文・解答の参照が可能です。誤操作に備えて操作ログを保持しており、取り消しややり直しに相当する操作を行えます。想定外の進行や限定問題数での判定などに使える「手動編集モード」も用意しており、スコアや背景色を直接調整できます。プレイヤーの勝ち抜けは画面中央に大きく表示され、スマートフォン等の外部画面でも視認性を保った表示が可能です。

## オンライン機能

Google アカウントによるサインインに対応し、サーバー側 API（Hono）と連携してデータを管理できます。オンラインのプレイヤー管理はローカルと同等の作成・インポート体験を提供し、問題管理も API 経由でセット単位の取得や保存を行います。ゲーム一覧からは各ゲームの公開可否を含むメタ情報にアクセスでき、ゲーム詳細ではプレイヤー構成やログを取得したうえでオンラインの得点表示を実行します。ユーザー設定ではテーマや表示オプション、ヘッダーの表示有無、問題番号の表示、勝ち抜けポップアップの有効化、Discord Webhook の登録などを管理できます。

公開設定されたゲームは、認証不要の「観戦モード」を通じて共有できます。観戦モードは Viewer 用 API を用いて初期データを取得し、専用のヘッダーとボードで状況を表示します。Discord Webhook を設定したゲームでは、勝ち抜けやリセットのイベント時に自動で通知が送られ、観戦用 URL への導線も含めたメッセージを送信します。これにより、会場外の視聴者や運営メンバーへの即時共有が可能になります。

## 対応ゲーム形式とスコア計算

スコア計算は形式ごとに独立したロジックで実装され、共通インターフェースで統一的に扱われます。対応している形式は次のとおりです：normal、nomx、nomx-ad、ny、nomr、nbyn、nupdown、divide、swedish10、backstream、attacksurvival、squarex、z、freezex、endless-chance、variables、aql。各形式の仕様は `docs/rules/` 以下にまとめられており、勝ち抜け・敗退条件やポイント遷移、特殊ルールなどの挙動を確認できます。オンライン側でも同様のアルゴリズムで計算され、ログとプレイヤー情報から現在の順位や勝ち抜け判定を導出します。

## 画面構成の概要

トップページではアプリの概要と主要機能の紹介、注意事項の案内を提供します。メインの管理エリアには、プレイヤー管理、問題管理、形式一覧、作成済みゲーム一覧があり、各ページは可能な限りサーバーコンポーネントで初期データを取得して描画します。得点表示ページはローカル用とオンライン用が用意され、いずれも動的レンダリングで最新の状態を反映します。観戦モードはオンラインのゲームに対する公開ビューで、認証なしにアクセスできるため配信用や大型スクリーンでの提示に適しています。ドキュメントエリアにはアプリ情報、推奨環境、利用規約、プライバシーポリシー、商用利用に関する記載がまとまっています。

## データ保存と動作環境

ローカル運用ではブラウザ内の IndexedDB にデータを保存します。アップデート時にデータがリセットされる可能性がある旨をあらかじめ案内しており、重要データはエクスポートでのバックアップが推奨されます。オンライン運用ではサーバー側のデータベースに保存され、Hono ベースの API を通じて取得・更新を行います。アプリは PWA としてのオフライン動作にも配慮した構成で、ネットワークが不安定な環境でも基本的な運用を継続できます。

## 技術的な補足

アプリは Next.js App Router と TypeScript で実装され、UI には Mantine、スタイルは CSS Modules を採用しています。フロントエンドからのデータ取得は API Routes のみを使用し、Hono クライアントを介して行われます。サーバー側では Zod による厳密なスキーマバリデーションを行い、各機能のモデル定義は `src/models/` に集約されています。サインインには Better Auth を使用し、Google 認証をサポートします。これらの構成により、安定した表示と厳密なデータ整合性を両立しつつ、競技現場で必要な即応性を確保しています。

## オンライン版の操作フロー

オンライン版は、Google アカウントでログインして利用します。ログイン状態ではヘッダー内のサイドバーメニュー（SubMenu）が自動的にオンライン向けリンクに切り替わり、「形式一覧」「作成したゲーム」「プレイヤー管理」「問題管理」の各メニューはそれぞれ `/online/rules`、`/online/games`、`/online/players`、`/online/quizes` に遷移します。未ログイン時は同名のローカル版ページ（`/rules`、`/games`、`/players`、`/quizes`）が表示されます。オンライン運用を行う場合は、まずログインしてオンラインメニューに切り替わっていることを確認してください。

最初に `/sign-in` でサインインします。サインイン後はアカウント設定ページ（`/user`）にアクセスでき、テーマや得点表示のオプション、勝ち抜けポップアップ、ヘッダー表示、問題番号の表示、Discord Webhook の URL などを設定できます。これらの設定はオンライン版の得点表示にも反映されます。

プレイヤーは `/online/players` で管理します。個別作成、テキスト貼り付けによる一括登録、CSV インポートに対応し、登録済みのプレイヤーは検索や選択・一括削除が可能です。登録・削除・再取得などの操作はすべて API Routes 経由で実行され、結果はテーブルに即時反映されます。

問題は `/online/quizes` で管理します。セット名やカテゴリ、問題番号を含む基本項目を扱い、初回描画時にサーバーから問題一覧を取得します。必要に応じてセット単位での運用や、検索・絞り込みを行いながら登録内容を整えます。

ゲームの新規作成は `/online/rules` から行います。作成したい形式を選ぶとゲーム名入力のモーダルが開き、確定するとサーバー側でゲームが作成されます。作成完了後は自動的に `/online/games/[game_id]/config` に遷移し、プレイヤーの並び順、初期スコアやカウント、形式固有のオプションなどを設定できます。

得点表示は運営向けと観戦向けの二種類があります。運営向けは `/online/games/[game_id]/board` で、ログとプレイヤー情報をもとにリアルタイムにスコアや勝ち抜け状態が反映されます。観戦向けは `/online/viewer/[game_id]` で、認証不要の Viewer API を通じて公開可能なゲームの状況を表示します。観戦 URL は配信・大型スクリーンでの提示に適しており、ゲームを公開設定にして共有することで、外部の視聴者にも最新のスコア状況を届けることができます。

通知が必要な場合は、`/user` のユーザー設定で Discord Webhook を登録してください。勝ち抜けやリセットなどのイベント発生時に自動でメッセージが送信され、観戦ページへのリンクも含めて関係者に即時に共有されます。オンライン運用では、サーバー側 API と連携したデータ整合性と即時反映を前提に、ローカル運用と同等の操作感を保ちながら、公開・共有・通知の導線を拡張しています。
