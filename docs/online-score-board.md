# オンライン版・得点表示（ボード）実装ガイド

本ドキュメントは、オンライン版の得点表示画面（スコアボード）を実装するための詳細な手順と設計指針を示す。既存のローカル版のUIとロジックを踏襲しながら、データ取得と更新のみをAPI連携に置き換える。URL命名は`/online/...`で統一し、`cloud-`という接頭辞は使用しない。初期リリースにおいて「editable」の機能は提供しない。また、リアルタイム更新（SSE/WebSocket）は初期段階では考慮しない。クイズの表示機能は将来的なタスクとしてこの文書末尾に追記する。

オンライン版のページ構造は、現行の`src/app/(board)/online/games/[game_id]/board`を用いる。サーバーコンポーネントでユーザーを取得し、クライアントコンポーネントに`game_id`とユーザー情報を渡す。クライアント側ではAPIクライアントを用いてゲーム詳細・プレイヤー・ログを取得し、取得したログを既存の計算関数へ入力できる形に整形してスコアを算出する。算出結果はローカル版と同じインターフェースで扱い、表示コンポーネントに渡す。

データ取得は初期描画時の一度に限定する。ユーザー操作によるデータ更新（正解・誤答・スルー・元に戻す）は、操作成功後に必要な最小限の再取得を行う。これにより、初期実装ではリアルタイム同期要件を課さず、操作に応じた確定的な更新を優先する。後続フェーズでリアルタイム化が必要になった場合、SSEやWebSocketによる購読に置き換えられるよう、データ取得関数の単一責務化とコンポーネント分割を意識して設計する。

スコア計算は既存の`src/utils/computeScore`配下の各形式別ロジックを再利用する。APIから取得したゲーム情報・設定・プレイヤー・ログを、ローカル版が想定する`GamePropsUnion`と`LogDBProps`に対応する「仮想ゲームオブジェクト」と「正規化ログ」に変換する小さなユーティリティを用意する。これにより、形式ごとの複雑な計算手続きは一切書き換えずに流用できる。具体的には、APIの`ruleType`を`rule`にマップし、`rules.ts`の既定値をベースに`/api/games/:gameId/settings`の値で上書きする。プレイヤーは`GameDBPlayerProps`相当に整形し、`base_correct_point`と`base_wrong_point`は1を設定する。AQLなどオプション値を要する形式は、`settings`の`leftTeam`や`rightTeam`を`options`に反映する。DiscordのWebhook通知や`last_open`などローカル特有のフィールドはオンライン版では使用しない。

UIはMantineとCSS Modulesで構築し、既存のローカル版の見た目と操作感を再現する。画面上部のヘッダーではゲーム名と形式ラベルを表示し、右側にメニューを配置する。メニューには「一つ戻す」「フルスクリーン」「表示設定」「ゲーム設定へのリンク」を配置するが、「スコアの手動更新（editable）」は提供しない。プレイヤーの一覧はローカル版と同様のレイアウトで表示し、各プレイヤーカードにスコア、状態、リーチなどの情報を示す。カードのクリック操作で正解・誤答を記録できるようにし、API呼び出し中は`useTransition`を用いてボタンの多重押下を防止し、ローディング状態を明示する。

操作ハンドリングはキーボードショートカットを含む。ローカル版と同様に、数字キーで正解、Shift+数字で誤答、ピリオドでスルー、カンマやCtrl/Cmd+Zで「一つ戻す」を実装する。ただし、オンライン版ではショートカット発火時にDexieではなくAPIに対して`POST /api/games/logs`や`DELETE /api/games/logs/:logId`を呼び出す。`incapacity`状態にあるプレイヤーへの操作は抑止し、押下を無視する。連続誤答や休み人数の条件が満たされた場合のスキップサジェストもローカル版と同様の判定を用いて実装し、「スルー」または「スキップ」を選択すると対応するログを追加する。

ログ表示はローカル版同様にテーブルで表現し、昇順・降順の切り替えと、HTMLテーブル形式でのクリップボードコピー機能を提供する。初期段階ではクイズの同時表示は行わない。クイズ連携はAPI側の拡張に合わせて導入する予定であり、問題セットとオフセットに基づく同期表示を後述のタスクにて扱う。

エラーハンドリングは最小限に留め、API失敗時には軽微なエラー表示とコンソールログを行う。サインインが必要な場合はサーバー側の`getUser()`で判定し、未ログインならばサインインページへの誘導を行う設計とする。型についてはAPIレスポンスを信頼し、型アサーションを避ける。Zodによるバリデーションはサーバーのコントローラー層で徹底し、フロントでは受信したデータをそのまま扱う。

今後の拡張としては、リアルタイム更新とクイズ表示の統合を予定する。リアルタイム更新はSSEまたはWebSocketによるログストリームを導入し、取得済みログの末尾に差分を反映する実装とする。クイズ表示は、クイズセット名とオフセットをAPIから取得し、ログの順序とスキップログの有無を考慮した対応付けによって問題文と解答を同時表示する。これらの拡張は既存のデータ取得と整形の責務を分離しているため、影響範囲は限定的である。

本実装の完了条件は、オンライン版の得点表示ページ上で、初期データの表示、正解・誤答・スルー・元に戻す操作の反映、スコアの正確な再計算、ヘッダー・プレイヤー一覧・操作ボタン・ログ表示・勝ち抜けモーダル・スキップサジェストがローカル版と等価の体験で提供されることである。初期段階ではポーリングや継続的な再取得は必須ではなく、ユーザー操作に応じた再取得のみで十分とする。最終的には、型チェックおよびリントの実行をもって品質を確認する。

なお、本ガイドに従い、オンライン機能のURL命名は`/online/...`に統一し、`cloud-`という命名規約はすべて撤廃する。`editable`の機能は提供しない。クイズの表示は将来の拡張タスクとして扱い、APIの整備に合わせて導入する。

# 付録: クイズ表示の後続タスク

クイズの同時表示機能は、クイズセットとオフセットを用いた問題列の取得、ログとの対応付け、スキップログの取り扱い、画面上での問題文と解答の表示を含む。オンラインAPIにクイズ取得のエンドポイントを追加し、問題セット名での検索と昇順取得を行う。ローカル版の表示に準拠しつつ、降順表示時のインデックス変換にも対応する。UI側の実装は既存のログテーブルに列を追加する形で行い、API連携の準備が整い次第段階的に導入する。

---

# TODO（進捗管理）

- [x] サーバーコンポーネントで初期データ取得（ゲーム/プレイヤー/ログ/設定）を実装する（`page.tsx`）
- [x] クライアント側で初期データを受け取り表示する土台を実装する（ヘッダー、プレイヤー一覧、ログ件数）
- [x] API経由の操作（正解/誤答/スルー/一つ戻す）を実装する（`useTransition`で多重押下防止）
- [x] スコア計算の実装：オンライン版専用の独立関数を作成し（`src/utils/online/computeScore.ts`）、APIレスポンス（ゲーム・プレイヤー・ログ・設定）から直接算出する（現時点で normal/nomx/ny/nomr をサポート、他形式は順次拡張）
- [ ] UI統合：ローカル版の`Players`/`AQL`/`GameLogs`コンポーネント相当のオンライン版コンポーネントを実装（Dexie依存を排除してAPI呼び出しに置換）
- [x] キーボードショートカットの実装（数字=正解、Shift+数字=誤答、ピリオド=スルー、カンマ/Ctrl/Cmd+Z=戻す）
- [x] スキップサジェストの実装（連続誤答・休み人数条件に応じて表示、スルー/スキップ操作対応）
- [ ] 勝ち抜けモーダルの実装（既存`WinModal`の体験を再現）
- [x] ヘッダーの拡充（フルスクリーン/表示設定/ゲーム設定リンク・一つ戻すの追加）
- [x] ログ表示テーブルとHTMLコピー機能の実装（昇順/降順切替対応）
- [ ] エラーハンドリング/トーストの整備（失敗時のユーザー通知・軽微な表示）
- [ ] 型の厳密化と不要な型アサーション排除（APIレスポンスを信頼しつつ型整合）
